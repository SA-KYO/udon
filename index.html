const SHEET_ID = '1i7NnI3f_0oYd5XgW9Se0LPz-4IQOfCu6N3XCs0mLRHk';  // スプレッドシートのID
const SHEET_NAME = 'シート1';  // 対象シート名
const DRIVE_FOLDER_ID = '1QtYgxom5gGqOOUdSW2VDB_vc60-qsWuk';  // ファイル保存先
const EMAIL = "caress.of.venus.81108110@gmail.com";  // 通知先メールアドレス

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);

    const storeName     = e.parameter.storeName || "";
    const phone         = e.parameter.phone || "";
    const address       = e.parameter.address || "";
    const contactPerson = e.parameter.contactPerson || "";
    const equipmentType = e.parameter.equipmentType || "";
    const modelNumber   = e.parameter.modelNumber || "";
    
    let issues = "";
    if (e.parameter.issues) {
      issues = Array.isArray(e.parameter.issues) ? e.parameter.issues.join(", ") : e.parameter.issues;
    }

    const details   = e.parameter.details || "";
    const userId    = e.parameter.userId || "";
    const lineName  = e.parameter.lineName || "";

    let fileIdOrUrl = "";
    if (e.parameter.fileData && e.parameter.fileName) {
      const data = Utilities.base64Decode(e.parameter.fileData);
      const blob = Utilities.newBlob(data, e.parameter.fileMimeType || MimeType.PNG, e.parameter.fileName);
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      const file = folder.createFile(blob);
      fileIdOrUrl = file.getUrl();  // 公開リンク（事前に共有設定推奨）
    }

    // スプレッドシートへ書き込み
    sheet.appendRow([
      new Date(), storeName, phone, address, contactPerson,
      equipmentType, modelNumber, issues, details,
      fileIdOrUrl, userId, lineName
    ]);

    // メール通知
    let body = "";
    body += "店舗名: " + storeName + "\n";
    body += "電話番号: " + phone + "\n";
    body += "住所: " + address + "\n";
    body += "担当者名: " + contactPerson + "\n";
    body += "機器の種類: " + equipmentType + "\n";
    body += "型番: " + modelNumber + "\n";
    body += "故障内容: " + issues + "\n";
    body += "詳細説明:\n" + details + "\n";

    if (fileIdOrUrl) {
      body += "写真/動画ファイル URL: " + fileIdOrUrl + "\n";
    }
    if (userId) {
      body += "\n送信者 LINE UserID: " + userId;
    }

    MailApp.sendEmail(EMAIL, "【LINE修理依頼】" + storeName + "より送信あり", body);

    // ✅ 成功レスポンス（JSON形式で .done() に渡す）
    return ContentService
      .createTextOutput(JSON.stringify({ status: "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error(error);
    // ✅ エラーレスポンス（JSON形式）
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
